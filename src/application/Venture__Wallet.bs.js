// Generated by BUCKLESCRIPT VERSION 3.1.5, PLEASE EDIT WITH CARE
'use strict';

var Curry = require("bs-platform/lib/js/curry.js");
var Event = require("./events/Event.bs.js");
var Policy = require("./Policy.bs.js");
var Address = require("./wallet/Address.bs.js");
var PrimitiveTypes = require("./PrimitiveTypes.bs.js");
var PayoutTransaction = require("./wallet/PayoutTransaction.bs.js");
var WalletInfoCollector = require("./wallet/WalletInfoCollector.bs.js");

function make() {
  return /* record */[
          /* ventureId */PrimitiveTypes.VentureId[/* fromString */1](""),
          /* network : Regtest */0,
          /* payoutPolicy */Policy.unanimous,
          /* walletInfoCollector */WalletInfoCollector.make(/* () */0)
        ];
}

function apply($$event, state) {
  var state_000 = /* ventureId */state[/* ventureId */0];
  var state_001 = /* network */state[/* network */1];
  var state_002 = /* payoutPolicy */state[/* payoutPolicy */2];
  var state_003 = /* walletInfoCollector */WalletInfoCollector.apply($$event, state[/* walletInfoCollector */3]);
  var state$1 = /* record */[
    state_000,
    state_001,
    state_002,
    state_003
  ];
  if ($$event.tag) {
    return state$1;
  } else {
    var match = $$event[0];
    return /* record */[
            /* ventureId */match[/* ventureId */0],
            /* network */match[/* network */6],
            /* payoutPolicy */match[/* metaPolicy */4],
            state_003
          ];
  }
}

function exposeNextIncomeAddress(userId, accountIdx, param) {
  var walletInfoCollector = param[/* walletInfoCollector */3];
  var accountKeyChain = WalletInfoCollector.currentKeyChain(accountIdx, userId, walletInfoCollector);
  var coordinates = Address.Coordinates[/* nextExternal */2](userId, WalletInfoCollector.exposedCoordinates(walletInfoCollector), accountKeyChain);
  return Event.IncomeAddressExposed[/* make */0](userId, Address.make(coordinates, accountKeyChain));
}

function preparePayoutTx(eligibleWhenProposing, param, accountIdx, destinations, satsPerByte, param$1) {
  var walletInfoCollector = param$1[/* walletInfoCollector */3];
  var userId = param[/* userId */0];
  try {
    var payoutTx = PayoutTransaction.build(WalletInfoCollector.nonReservedOldInputs(accountIdx, userId, walletInfoCollector), WalletInfoCollector.spendableInputs(accountIdx, walletInfoCollector), destinations, satsPerByte, WalletInfoCollector.nextChangeAddress(accountIdx, userId, walletInfoCollector), WalletInfoCollector.network(walletInfoCollector));
    var match = PayoutTransaction.signPayout(param$1[/* ventureId */0], userId, param[/* masterKeyChain */4], WalletInfoCollector.accountKeyChains(walletInfoCollector), payoutTx);
    var payoutTx$1 = match ? match[0] : payoutTx;
    return /* Ok */[Curry._6(Event.Payout[/* Proposed */3][/* make */0], /* None */0, /* None */0, eligibleWhenProposing, userId, param$1[/* payoutPolicy */2], /* record */[
                  /* accountIdx */accountIdx,
                  /* payoutTx */payoutTx$1
                ])];
  }
  catch (exn){
    if (exn === PayoutTransaction.NotEnoughFunds) {
      return /* NotEnoughFunds */0;
    } else {
      throw exn;
    }
  }
}

exports.make = make;
exports.apply = apply;
exports.exposeNextIncomeAddress = exposeNextIncomeAddress;
exports.preparePayoutTx = preparePayoutTx;
/* Event Not a pure module */
